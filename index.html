<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINE Check-in/Check-out</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    h2 {
      color: #1a1a1a;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .version {
      color: #999;
      font-size: 12px;
      margin-bottom: 20px;
    }
    
    #status {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    #status.loading {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }
    
    #status.ready {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
    }
    
    #status.error {
      background: #ffe6e6;
      color: #cc0000;
      border: 1px solid #ffcccc;
    }
    
    #status.success {
      background: #e6ffe6;
      color: #006600;
      border: 1px solid #ccffcc;
    }
    
    #status.warning {
      background: #fff9e6;
      color: #996600;
      border: 1px solid #ffedcc;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      color: white;
      border: none;
      padding: 15px 20px;
      font-size: 16px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    #btnCheckin {
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    #btnCheckout {
      background: linear-gradient(135deg, #4a4a4a 0%, #2d2d2d 100%);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #f0f0f0;
      border-top: 3px solid #1a1a1a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    .spinner.active {
      display: block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .info-box {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 13px;
      color: #666;
      text-align: left;
      border: 1px solid #e0e0e0;
    }
    
    .info-box strong {
      color: #1a1a1a;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .status-card {
      background: white;
      border: 2px solid #e0e0e0;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }
    
    .status-card.completed {
      border-color: #1a1a1a;
      background: #f5f5f5;
    }
    
    .status-card .label {
      font-size: 11px;
      color: #999;
      margin-bottom: 5px;
    }
    
    .status-card .value {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .status-card .time {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚è∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
    <div class="version">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 1.3</div>
    
    <div class="spinner" id="spinner"></div>
    <div id="status" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>
    
    <div class="button-group">
      <button id="btnCheckin" class="btn" disabled>
        <span>üü¢</span> Check In
      </button>
      <button id="btnCheckout" class="btn" disabled>
        <span>üî¥</span> Check Out
      </button>
    </div>
    
    <div class="info-box" id="infoBox" style="display:none;">
      <strong>üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong><br>
      <span id="userInfo">-</span>
      
      <div class="status-grid" id="statusGrid" style="display:none;">
        <div class="status-card" id="checkinCard">
          <div class="label">CHECK IN</div>
          <div class="value" id="checkinStatus">-</div>
          <div class="time" id="checkinTime"></div>
        </div>
        <div class="status-card" id="checkoutCard">
          <div class="label">CHECK OUT</div>
          <div class="value" id="checkoutStatus">-</div>
          <div class="time" id="checkoutTime"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const CONFIG = {
      liffId: "2008403464-kaXOK95X",
      gasUrl: "https://script.google.com/macros/s/AKfycbzHary7G7KCQ3mvcfWlAa3DO1gszDmUUbhV9isr78Ov1sP5wUhMjy9J-ClrKVzt8gPFBg/exec",
      geoOptions: {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    };

    const UI = {
      status: document.getElementById('status'),
      btnCheckin: document.getElementById('btnCheckin'),
      btnCheckout: document.getElementById('btnCheckout'),
      spinner: document.getElementById('spinner'),
      infoBox: document.getElementById('infoBox'),
      userInfo: document.getElementById('userInfo'),
      statusGrid: document.getElementById('statusGrid'),
      checkinCard: document.getElementById('checkinCard'),
      checkoutCard: document.getElementById('checkoutCard'),
      checkinStatus: document.getElementById('checkinStatus'),
      checkoutStatus: document.getElementById('checkoutStatus'),
      checkinTime: document.getElementById('checkinTime'),
      checkoutTime: document.getElementById('checkoutTime'),

      setStatus(message, type = 'loading') {
        this.status.textContent = message;
        this.status.className = type;
      },

      showSpinner(show = true) {
        this.spinner.classList.toggle('active', show);
      },

      enableButtons(checkin = false, checkout = false) {
        this.btnCheckin.disabled = !checkin;
        this.btnCheckout.disabled = !checkout;
      },

      showUserInfo(profile) {
        if (profile && profile.displayName) {
          this.userInfo.textContent = `${profile.displayName}`;
          this.infoBox.style.display = 'block';
        }
      },

      updateStatusCards(todayStatus) {
        this.statusGrid.style.display = 'grid';
        
        if (todayStatus.checkedIn) {
          this.checkinCard.classList.add('completed');
          this.checkinStatus.textContent = '‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
          this.checkinTime.textContent = todayStatus.checkinTime;
        } else {
          this.checkinCard.classList.remove('completed');
          this.checkinStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô';
          this.checkinTime.textContent = '';
        }
        
        if (todayStatus.checkedOut) {
          this.checkoutCard.classList.add('completed');
          this.checkoutStatus.textContent = '‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß';
          this.checkoutTime.textContent = todayStatus.checkoutTime;
        } else {
          this.checkoutCard.classList.remove('completed');
          this.checkoutStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå';
          this.checkoutTime.textContent = '';
        }
      }
    };

    let userProfile = null;
    let todayStatus = {
      checkedIn: false,
      checkedOut: false,
      checkinTime: null,
      checkoutTime: null
    };

    async function initLiff() {
      try {
        UI.showSpinner(true);
        UI.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...', 'loading');

        await liff.init({ liffId: CONFIG.liffId });

        if (!liff.isLoggedIn()) {
          UI.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'loading');
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        
        await checkTodayStatus();
        
        UI.showUserInfo(userProfile);
        UI.updateStatusCards(todayStatus);
        updateButtonStates();
        
        UI.setStatus('‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'ready');
        UI.showSpinner(false);

      } catch (error) {
        console.error('LIFF Init Error:', error);
        UI.setStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
        UI.showSpinner(false);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    async function checkTodayStatus() {
      try {
        const now = new Date();
        const thaiDate = now.toLocaleDateString('th-TH', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        
        console.log('Checking status for:', userProfile.userId, 'Date:', thaiDate);
        
        const response = await fetch(`${CONFIG.gasUrl}?action=checkStatus&userId=${encodeURIComponent(userProfile.userId)}&date=${encodeURIComponent(thaiDate)}`);
        const data = await response.json();
        
        console.log('Status response:', data);
        
        if (data.status === 'ok' && data.todayStatus) {
          todayStatus = {
            checkedIn: data.todayStatus.checkedIn || false,
            checkedOut: data.todayStatus.checkedOut || false,
            checkinTime: data.todayStatus.checkinTime || null,
            checkoutTime: data.todayStatus.checkoutTime || null
          };
          console.log('Updated todayStatus:', todayStatus);
        }
      } catch (error) {
        console.error('Check Status Error:', error);
      }
    }

    function updateButtonStates() {
      const canCheckin = !todayStatus.checkedIn;
      const canCheckout = todayStatus.checkedIn && !todayStatus.checkedOut;
      
      UI.enableButtons(canCheckin, canCheckout);
    }

    function getGeolocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => {
            let errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMsg = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS';
                break;
              case error.TIMEOUT:
                errorMsg = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                break;
            }
            reject(new Error(errorMsg));
          },
          CONFIG.geoOptions
        );
      });
    }

    function formatThaiTime(date) {
      return date.toLocaleString('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    }

    async function sendToGAS(type, lat, lon) {
      const now = new Date();
      const thaiDate = now.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const thaiTime = formatThaiTime(now);
      
      const payload = {
        action: type,
        userId: userProfile?.userId || '',
        displayName: userProfile?.displayName || 'Unknown',
        date: thaiDate,
        timestamp: now.toISOString()
      };

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° action
      if (type === 'checkin') {
        payload.checkinTime = thaiTime;
        payload.checkinLat = lat;
        payload.checkinLon = lon;
      } else if (type === 'checkout') {
        payload.checkoutTime = thaiTime;
        payload.checkoutLat = lat;
        payload.checkoutLon = lon;
      }

      console.log('Sending payload:', payload);

      try {
        const response = await fetch(CONFIG.gasUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload),
          redirect: 'follow'
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ no-cors ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏î‡πâ
        // ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        console.log('Request sent successfully');
        return { status: 'ok', action: type, time: type === 'checkin' ? thaiTime : thaiTime };
        
      } catch (error) {
        console.error('Fetch error:', error);
        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
      }
    }

    async function sendLineMessage(type, time) {
      const message = type === 'checkin' 
        ? `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${time}`
        : `üî¥ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${time}`;

      try {
        if (liff.isInClient()) {
          await liff.sendMessages([{
            type: 'text',
            text: message
          }]);
        }
      } catch (error) {
        console.error('Send Message Error:', error);
      }
    }

    async function performAction(type) {
      try {
        UI.enableButtons(false, false);
        UI.showSpinner(true);
        UI.setStatus('üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î...', 'loading');

        const position = await getGeolocation();
        const { latitude: lat, longitude: lon } = position.coords;

        UI.setStatus('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'loading');

        const result = await sendToGAS(type, lat, lon);

        if (result.status === 'error') {
          throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }

        const now = new Date();
        const timeStr = formatThaiTime(now);
        
        if (type === 'checkin') {
          todayStatus.checkedIn = true;
          todayStatus.checkinTime = timeStr;
          UI.setStatus('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
          todayStatus.checkedOut = true;
          todayStatus.checkoutTime = timeStr;
          UI.setStatus('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        UI.updateStatusCards(todayStatus);
        updateButtonStates();
        UI.showSpinner(false);

        await sendLineMessage(type, timeStr);

        setTimeout(() => {
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        }, 2000);

      } catch (error) {
        console.error('Action Error:', error);
        UI.setStatus('‚ùå ' + error.message, 'error');
        UI.showSpinner(false);
        updateButtonStates();
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }

    document.getElementById('btnCheckin').addEventListener('click', () => performAction('checkin'));
    document.getElementById('btnCheckout').addEventListener('click', () => performAction('checkout'));

    window.addEventListener('load', initLiff);
  </script>
</body>
</html>
