<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö Check In / Check Out</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-info {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 18px;
      font-weight: 500;
    }

    .version {
      text-align: center;
      color: #999;
      font-size: 12px;
      margin-top: 20px;
      user-select: none;
    }

    .status-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.5s ease-out;
      margin-bottom: 25px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .status-card.loading {
      background: linear-gradient(135deg, #e0e7ff 0%, #cfd9ff 100%);
    }

    .status-card.success {
      background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
    }

    .status-card.warning {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }

    .status-card.error {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }

    .status-card.completed {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .status-text {
      font-size: 16px;
      color: #333;
      font-weight: 400;
      line-height: 1.6;
    }

    .status-title {
      font-size: 20px;
      color: #333;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .time-display {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .instruction {
      font-size: 15px;
      color: #555;
      margin-top: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.5);
      border-radius: 8px;
    }

    .button-container {
      min-height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .button-container.hidden {
      display: none;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      min-width: 200px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.checkout {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }

    button.checkout:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }

    .icon {
      font-size: 24px;
      margin-right: 8px;
    }

    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
      }

      button {
        width: 100%;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="user-info" id="userInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div id="statusCard" class="status-card loading">
      <div class="spinner"></div>
      <div class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</div>
    </div>

    <div class="button-container hidden" id="buttonContainer">
      <button id="actionBtn"></button>
    </div>

    <!-- Debug Log Panel -->
    <div id="debugLog" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; display: block;">
      <div style="font-weight: bold; margin-bottom: 10px; color: #667eea;">üêõ Debug Log (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á = ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)</div>
    </div>

    <div class="version">Version 2.1.0 - Debug Mode + ShareTargetPicker</div>
  </div>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ============================================
    // üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    // ============================================
    const CONFIG = {
      API_URL: "https://script.google.com/macros/s/AKfycby_YP4T3qfUZktoEIWDerjqewcl1KniSg2bwTGHwmjfg7VfYIUg8XpEXFXkDW5lFFCt9A/exec",
      LIFF_ID: "2008403464-kaXOK95X",
      DEBUG_MODE: true, // ‡πÄ‡∏õ‡∏¥‡∏î Debug Mode
      MAX_RETRIES: 3,
      RETRY_DELAY: 2000
    };

    // ============================================
    // üì± Elements
    // ============================================
    const elements = {
      actionBtn: document.getElementById("actionBtn"),
      buttonContainer: document.getElementById("buttonContainer"),
      statusCard: document.getElementById("statusCard"),
      userInfo: document.getElementById("userInfo")
    };

    // ============================================
    // üéØ State
    // ============================================
    const state = {
      currentAction: null,
      isProcessing: false,
      lineUserId: null,
      lineDisplayName: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
      liffInitialized: false
    };

    // ============================================
    // üêõ Debug Functions
    // ============================================
    function debugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString('th-TH');
      const logMessage = `[${timestamp}] ${message}`;
      
      if (CONFIG.DEBUG_MODE) {
        console.log(logMessage, data || '');
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á Debug Log ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢
      if (CONFIG.DEBUG_MODE) {
        const debugDiv = document.getElementById('debugLog');
        if (debugDiv) {
          const logEntry = document.createElement('div');
          logEntry.style.cssText = 'font-size: 11px; padding: 2px 0; color: #666; border-bottom: 1px solid #eee;';
          logEntry.textContent = logMessage + (data ? ' | ' + JSON.stringify(data).substring(0, 100) : '');
          debugDiv.insertBefore(logEntry, debugDiv.firstChild);
          
          // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 20 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          while (debugDiv.children.length > 20) {
            debugDiv.removeChild(debugDiv.lastChild);
          }
        }
      }
    }

    // ============================================
    // üîê LIFF Initialization
    // ============================================
    async function initializeLiff() {
      try {
        debugLog('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF...', { liffId: CONFIG.LIFF_ID });
        
        await liff.init({ liffId: CONFIG.LIFF_ID });
        debugLog('‚úÖ LIFF init ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        
        if (!liff.isLoggedIn()) {
          debugLog('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login, redirect...');
          liff.login();
          return false;
        }

        const profile = await liff.getProfile();
        
        state.lineUserId = profile.userId;
        state.lineDisplayName = profile.displayName;
        state.liffInitialized = true;
        
        debugLog('‚úÖ ‡∏î‡∏∂‡∏á Profile ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', {
          userId: state.lineUserId,
          displayName: state.lineDisplayName
        });
        
        elements.userInfo.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${state.lineDisplayName}`;
        
        return true;
      } catch (error) {
        debugLog('‚ùå LIFF Error', error);
        
        state.lineUserId = "TEST_" + Date.now();
        state.lineDisplayName = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
        state.liffInitialized = false;
        
        elements.userInfo.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${state.lineDisplayName} (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö)`;
        
        return true;
      }
    }

    // ============================================
    // üìÖ Date/Time Functions (Thailand Timezone)
    // ============================================
    function getThaiDate() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const thaiTime = new Date(utc + (7 * 3600000));
      
      const d = thaiTime.getDate().toString().padStart(2, '0');
      const m = (thaiTime.getMonth() + 1).toString().padStart(2, '0');
      const y = thaiTime.getFullYear() + 543;
      
      return `${d}/${m}/${y}`;
    }

    function getThaiDateTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const thaiTime = new Date(utc + (7 * 3600000));
      
      const d = thaiTime.getDate().toString().padStart(2, '0');
      const m = (thaiTime.getMonth() + 1).toString().padStart(2, '0');
      const y = thaiTime.getFullYear() + 543;
      const h = thaiTime.getHours().toString().padStart(2, '0');
      const min = thaiTime.getMinutes().toString().padStart(2, '0');
      const s = thaiTime.getSeconds().toString().padStart(2, '0');
      
      return `${d}/${m}/${y} ${h}:${min}:${s}`;
    }

    function getThaiDateTimeLong() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const thaiTime = new Date(utc + (7 * 3600000));
      
      const dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
      const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                          '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
      
      const dayName = dayNames[thaiTime.getDay()];
      const d = thaiTime.getDate();
      const monthName = monthNames[thaiTime.getMonth()];
      const y = thaiTime.getFullYear() + 543;
      const h = thaiTime.getHours().toString().padStart(2, '0');
      const min = thaiTime.getMinutes().toString().padStart(2, '0');
      
      return `‡∏ß‡∏±‡∏ô${dayName}‡∏ó‡∏µ‡πà ${d} ${monthName} ${y} ‡πÄ‡∏ß‡∏•‡∏≤ ${h}:${min} ‡∏ô.`;
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const parts = timeStr.split(':');
      return `${parts[0]}:${parts[1]} ‡∏ô.`;
    }

    function getCurrentTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const thaiTime = new Date(utc + (7 * 3600000));
      const h = thaiTime.getHours().toString().padStart(2, '0');
      const m = thaiTime.getMinutes().toString().padStart(2, '0');
      return `${h}:${m} ‡∏ô.`;
    }

    // ============================================
    // üìç GPS Functions
    // ============================================
    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
          return;
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        };

        debugLog('üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠ GPS...');

        navigator.geolocation.getCurrentPosition(
          pos => {
            debugLog('‚úÖ ‡πÑ‡∏î‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS', {
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            });
            resolve({
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            });
          },
          err => {
            debugLog('‚ùå GPS Error', err);
            reject('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS');
          },
          options
        );
      });
    }

    // ============================================
    // üí¨ LINE Message Reply Functions (‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡∏°‡πà - ‡πÉ‡∏ä‡πâ Share Target Picker)
    // ============================================
    async function sendLineReplyMessage(action, dateTime) {
      debugLog('üì§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendLineReplyMessage', { 
        action, 
        dateTime, 
        liffInitialized: state.liffInitialized 
      });

      if (!state.liffInitialized) {
        debugLog('‚ö†Ô∏è LIFF ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡∏Ç‡πâ‡∏≤‡∏° sendMessage');
        return false;
      }

      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ LIFF API ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        debugLog('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF APIs', {
          isInClient: liff.isInClient(),
          isLoggedIn: liff.isLoggedIn(),
          hasShareTargetPicker: liff.isApiAvailable('shareTargetPicker'),
          hasSendMessages: liff.isApiAvailable('sendMessages')
        });

        let messageText = '';
        
        if (action === 'checkin') {
          messageText = `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                       `üë§ ‡∏Ñ‡∏∏‡∏ì${state.lineDisplayName}\n` +
                       `üìÖ ${getThaiDateTimeLong()}\n\n` +
                       `‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üí™`;
        } else if (action === 'checkout') {
          messageText = `üèÅ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                       `üë§ ‡∏Ñ‡∏∏‡∏ì${state.lineDisplayName}\n` +
                       `üìÖ ${getThaiDateTimeLong()}\n\n` +
                       `‚ú® ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n` +
                       `‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
        }

        debugLog('üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á:', messageText);

        // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≠‡∏á sendMessages ‡∏Å‡πà‡∏≠‡∏ô
        if (liff.isApiAvailable('sendMessages')) {
          debugLog('‚úÖ ‡∏û‡∏ö sendMessages API, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...');
          
          try {
            await liff.sendMessages([
              {
                type: 'text',
                text: messageText
              }
            ]);
            
            debugLog('‚úÖ sendMessages ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            
            // ‡∏£‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            setTimeout(() => {
              debugLog('üîí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF...');
              liff.closeWindow();
            }, 1500);
            
            return true;
            
          } catch (sendError) {
            debugLog('‚ùå sendMessages ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', sendError);
            
            // ‡∏ñ‡πâ‡∏≤ sendMessages ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á shareTargetPicker
            if (liff.isApiAvailable('shareTargetPicker')) {
              debugLog('üîÑ ‡∏•‡∏≠‡∏á shareTargetPicker ‡πÅ‡∏ó‡∏ô...');
              
              await liff.shareTargetPicker([
                {
                  type: 'text',
                  text: messageText
                }
              ]);
              
              debugLog('‚úÖ shareTargetPicker ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
              return true;
            }
          }
        } 
        // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ sendMessages ‡πÉ‡∏ä‡πâ shareTargetPicker
        else if (liff.isApiAvailable('shareTargetPicker')) {
          debugLog('üì§ ‡πÑ‡∏°‡πà‡∏°‡∏µ sendMessages, ‡πÉ‡∏ä‡πâ shareTargetPicker...');
          
          await liff.shareTargetPicker([
            {
              type: 'text',
              text: messageText
            }
          ]);
          
          debugLog('‚úÖ shareTargetPicker ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          return true;
        } 
        // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
        else {
          debugLog('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏¢');
          
          // ‡πÅ‡∏™‡∏î‡∏á alert ‡πÅ‡∏ó‡∏ô
          alert(messageText);
          
          setTimeout(() => {
            liff.closeWindow();
          }, 1000);
          
          return false;
        }

      } catch (error) {
        debugLog('üí• Error ‡πÉ‡∏ô sendLineReplyMessage:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!\n\n${action === 'checkin' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô' : '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå'}: ${dateTime}`);
        
        setTimeout(() => {
          liff.closeWindow();
        }, 1500);
        
        return false;
      }
    }

    // ============================================
    // üé® UI Functions
    // ============================================
    function showActionButton(action) {
      state.currentAction = action;
      elements.buttonContainer.classList.remove('hidden');
      
      if (action === 'checkin') {
        elements.actionBtn.className = '';
        elements.actionBtn.innerHTML = '<span class="icon">‚úÖ</span> Check In';
        elements.actionBtn.disabled = false;
      } else if (action === 'checkout') {
        elements.actionBtn.className = 'checkout';
        elements.actionBtn.innerHTML = '<span class="icon">üèÅ</span> Check Out';
        elements.actionBtn.disabled = false;
      }
      
      debugLog('‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°', { action, disabled: elements.actionBtn.disabled });
    }

    function hideActionButton() {
      elements.buttonContainer.classList.add('hidden');
      state.currentAction = null;
    }

    function updateStatus(title, message, type = 'info', timeInfo = '', instruction = '') {
      elements.statusCard.className = `status-card ${type}`;
      
      let content = '';
      if (title) {
        content += `<div class="status-title">${title}</div>`;
      }
      content += `<div class="status-text">${message}</div>`;
      
      if (timeInfo) {
        content += `<div class="time-display">${timeInfo}</div>`;
      }
      
      if (instruction) {
        content += `<div class="instruction">${instruction}</div>`;
      }
      
      elements.statusCard.innerHTML = content;
    }

    function setLoading(loading, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
      state.isProcessing = loading;
      elements.actionBtn.disabled = loading;
      
      if (loading) {
        elements.statusCard.className = 'status-card loading';
        elements.statusCard.innerHTML = `
          <div class="spinner"></div>
          <div class="status-text">${message}</div>
        `;
      }
    }

    // ============================================
    // üöÄ API Functions with Retry
    // ============================================
    async function fetchWithRetry(url, options, retries = CONFIG.MAX_RETRIES) {
      for (let i = 0; i < retries; i++) {
        try {
          debugLog(`üîÑ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (${i + 1}/${retries})...`);
          
          const response = await fetch(url, options);
          
          debugLog(`üì° Response: ${response.status} ${response.statusText}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const text = await response.text();
          debugLog('üìÑ Response text:', text.substring(0, 200));
          
          const data = JSON.parse(text);
          debugLog('‚úÖ Parse JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', data);
          
          return data;
          
        } catch (error) {
          debugLog(`‚ùå ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i + 1} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, error.message);
          
          if (i === retries - 1) {
            throw error;
          }
          
          debugLog(`‚è≥ ‡∏£‡∏≠ ${CONFIG.RETRY_DELAY}ms ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...`);
          await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
        }
      }
    }

    async function sendAction() {
      if (state.isProcessing || !state.currentAction) return;
      
      const actionToSend = state.currentAction;
      
      setLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á${actionToSend === 'checkin' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô' : '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå'}...`);
      hideActionButton();

      try {
        debugLog(`üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° ${actionToSend}...`);
        
        const location = await getLocation();
        const dateTime = getThaiDateTime();
        
        const payload = {
          action: actionToSend,
          userId: state.lineUserId,
          displayName: state.lineDisplayName,
          date: getThaiDate(),
          dateTime: dateTime,
          checkinLat: location.lat,
          checkinLon: location.lon,
          checkoutLat: location.lat,
          checkoutLon: location.lon
        };

        debugLog('üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', payload);

        const result = await fetchWithRetry(CONFIG.API_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: { 
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(payload)
        });
        
        if (result.status === 'ok') {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
          updateStatus(
            '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${actionToSend === 'checkin' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
            'success',
            `üìÖ ${dateTime}`
          );
          
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Reply ‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE Chat (‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏á)
          await sendLineReplyMessage(actionToSend, dateTime);
          
        } else {
          updateStatus(
            '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            result.message,
            'error'
          );
          setLoading(false);
          setTimeout(() => showActionButton(actionToSend), 2000);
        }

      } catch (error) {
        debugLog('üí• Error ‡πÉ‡∏ô sendAction:', error);
        updateStatus(
          '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ',
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
          'error',
          '',
          '‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        );
        setTimeout(checkStatus, 3000);
      }
    }

    async function checkStatus() {
      try {
        debugLog('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
        setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
        
        const date = getThaiDate();
        const url = `${CONFIG.API_URL}?action=checkStatus&userId=${encodeURIComponent(state.lineUserId)}&date=${encodeURIComponent(date)}`;
        
        debugLog('üì° URL:', url);

        const data = await fetchWithRetry(url, {
          method: "GET",
          mode: "cors",
          cache: "no-cache"
        });
        
        if (data.status === 'ok') {
          const s = data.todayStatus;
          
          if (s.checkedIn && s.checkedOut) {
            hideActionButton();
            updateStatus(
              'üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
              '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              'completed',
              `‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ${formatTime(s.checkinTime)} | ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô: ${formatTime(s.checkoutTime)}`,
              '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üí™'
            );
          } else if (s.checkedIn && !s.checkedOut) {
            showActionButton('checkout');
            updateStatus(
              'üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!',
              '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              'success',
              `‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ${formatTime(s.checkinTime)}`,
              `‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Check Out ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${getCurrentTime()})`
            );
          } else {
            showActionButton('checkin');
            updateStatus(
              '‚òÄÔ∏è ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤!',
              '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
              'warning',
              `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date}`,
              `‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Check In ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${getCurrentTime()})`
            );
          }
        } else {
          throw new Error(data.message || 'Invalid response');
        }
      } catch (error) {
        debugLog('üí• Error ‡πÉ‡∏ô checkStatus:', error);
        hideActionButton();
        
        updateStatus(
          '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á Google Apps Script',
          'error',
          '',
          `‡∏Ñ‡∏•‡∏¥‡∏Å "Test" ‡πÉ‡∏ô Apps Script ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π Execution log<br><small>${error.message}</small>`
        );
      } finally {
        state.isProcessing = false;
      }
    }

    // ============================================
    // üéØ Event Listeners
    // ============================================
    elements.actionBtn.addEventListener("click", function(e) {
      e.preventDefault();
      debugLog('üñ±Ô∏è ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏Å‡∏î!', { 
        action: state.currentAction, 
        isProcessing: state.isProcessing 
      });
      sendAction();
    });

    // ============================================
    // üöÄ Initialize App
    // ============================================
    async function initApp() {
      debugLog('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏û...');
      
      const liffReady = await initializeLiff();
      
      if (liffReady) {
        debugLog('‚úÖ LIFF ‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡πÄ‡∏£‡∏¥‡πà‡∏° checkStatus');
        await checkStatus();
        
        setInterval(() => {
          if (!state.isProcessing) {
            debugLog('üîÑ Auto refresh...');
            checkStatus();
          }
        }, 30000);
      } else {
        updateStatus(
          '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ',
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏û LINE',
          'error'
        );
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
