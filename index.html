<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check In / Check Out</title>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #333;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      width: 150px;
      transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>

  <h2>‡∏£‡∏∞‡∏ö‡∏ö Check In / Check Out</h2>

  <div>
    <button id="checkinBtn">‚úÖ Check In</button>
    <button id="checkoutBtn">üèÅ Check Out</button>
  </div>

  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</div>

  <script>
    // === üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Google Apps Script ===
    const API_URL = "https://script.google.com/macros/s/AKfycby51eek7mC5zt4dRK_TvaUKR2lMHapec2bjXGM5IrZ_B371B-nHUPFdN2_Cyfai-RZtcg/exec";

    // === üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏≠‡∏≤‡∏à‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° LINE User ID ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Login ‡∏≠‡∏∑‡πà‡∏ô) ===
    const userId = "U17814d04672b1adfcd8fe146d8bcb343";
    const displayName = "John Doe";

    // === üìÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/MM/yyyy (‡πÑ‡∏ó‡∏¢ ‡∏û.‡∏®.) ===
    function getThaiDate() {
      const now = new Date();
      const d = now.getDate().toString().padStart(2, '0');
      const m = (now.getMonth() + 1).toString().padStart(2, '0');
      const y = now.getFullYear() + 543; // ‡∏õ‡∏µ ‡∏û.‡∏®.
      return `${d}/${m}/${y}`;
    }

    // === üìç ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS ===
    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
        } else {
          navigator.geolocation.getCurrentPosition(
            pos => resolve({
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            }),
            err => reject('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ')
          );
        }
      });
    }

    // === üöÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Check In / Out ===
    async function sendAction(action) {
      try {
        const location = await getLocation();
        const payload = {
          action: action,
          userId: userId,
          displayName: displayName,
          date: getThaiDate(),
          checkinLat: location.lat,
          checkinLon: location.lon,
          checkoutLat: location.lat,
          checkoutLon: location.lon
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        document.getElementById("status").innerText = result.message || "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
      } catch (error) {
        document.getElementById("status").innerText = "‚ùå " + error;
      }
    }

    // === üïì ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Check Status) ===
    async function checkStatus() {
      const date = getThaiDate();
      const res = await fetch(`${API_URL}?action=checkStatus&userId=${userId}&date=${date}`);
      const data = await res.json();
      if (data.status === "ok") {
        const s = data.todayStatus;
        let text = "";
        if (s.checkedIn && !s.checkedOut) text = `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ß‡∏•‡∏≤ ${s.checkinTime}`;
        else if (s.checkedIn && s.checkedOut) text = `üèÅ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ß‡∏•‡∏≤ ${s.checkoutTime}`;
        else text = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
        document.getElementById("status").innerText = text;
      }
    }

    // === üéØ Event Buttons ===
    document.getElementById("checkinBtn").addEventListener("click", () => sendAction("checkin"));
    document.getElementById("checkoutBtn").addEventListener("click", () => sendAction("checkout"));

    // === ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ===
    checkStatus();
  </script>

</body>
</html>
