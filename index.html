<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINE Check-in</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .version {
      color: #999;
      font-size: 12px;
      margin-bottom: 20px;
    }
    
    #status {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    #status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    #status.ready {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    #status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    #status.success {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    #btnCheckin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      font-weight: 600;
    }
    
    #btnCheckin:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    #btnCheckin:active:not(:disabled) {
      transform: translateY(0);
    }
    
    #btnCheckin:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    .spinner.active {
      display: block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 13px;
      color: #666;
      text-align: left;
    }
    
    .info-box strong {
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìç LINE Check-in</h2>
    <div class="version">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 0.4</div>
    
    <div class="spinner" id="spinner"></div>
    <div id="status" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>
    
    <button id="btnCheckin" disabled>‚úÖ Check-in</button>
    
    <div class="info-box" id="infoBox" style="display:none;">
      <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</strong><br>
      <span id="userInfo">-</span>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const CONFIG = {
      liffId: "2008403464-kaXOK95X",
      gasUrl: "https://script.google.com/macros/s/AKfycbxlyqSlR7X8vO_okwYT7dj7rL21FHEg_RDVa6UrD1QHJEmucLbCq5KB5Wv12aKrl9h5tA/exec",
      geoOptions: {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    };

    const UI = {
      status: document.getElementById('status'),
      button: document.getElementById('btnCheckin'),
      spinner: document.getElementById('spinner'),
      infoBox: document.getElementById('infoBox'),
      userInfo: document.getElementById('userInfo'),

      setStatus(message, type = 'loading') {
        this.status.textContent = message;
        this.status.className = type;
      },

      showSpinner(show = true) {
        this.spinner.classList.toggle('active', show);
      },

      enableButton(enable = true) {
        this.button.disabled = !enable;
      },

      showUserInfo(profile) {
        if (profile && profile.displayName) {
          this.userInfo.textContent = `${profile.displayName} (${profile.userId.substring(0, 8)}...)`;
          this.infoBox.style.display = 'block';
        }
      }
    };

    let userProfile = null;

    async function initLiff() {
      try {
        UI.showSpinner(true);
        UI.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...', 'loading');

        await liff.init({ liffId: CONFIG.liffId });

        if (!liff.isLoggedIn()) {
          UI.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'loading');
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        
        UI.setStatus('‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'ready');
        UI.enableButton(true);
        UI.showSpinner(false);
        UI.showUserInfo(userProfile);

      } catch (error) {
        console.error('LIFF Init Error:', error);
        UI.setStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
        UI.showSpinner(false);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    function getGeolocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => {
            let errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMsg = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS';
                break;
              case error.TIMEOUT:
                errorMsg = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                break;
            }
            reject(new Error(errorMsg));
          },
          CONFIG.geoOptions
        );
      });
    }

    async function sendCheckinData(lat, lon) {
      const payload = {
        userId: userProfile?.userId || '',
        displayName: userProfile?.displayName || 'Unknown',
        lat: lat,
        lon: lon,
        timestamp: new Date().toISOString(),
        liffId: liff.getContext?.()?.liffId || CONFIG.liffId
      };

      const response = await fetch(CONFIG.gasUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });

      return { status: 'ok' };
    }

    async function doCheckin() {
      try {
        UI.enableButton(false);
        UI.showSpinner(true);
        UI.setStatus('üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î...', 'loading');

        const position = await getGeolocation();
        const { latitude: lat, longitude: lon } = position.coords;

        UI.setStatus('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'loading');

        await sendCheckinData(lat, lon);

        UI.setStatus('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        UI.showSpinner(false);

        setTimeout(() => {
          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            UI.setStatus('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ', 'success');
            UI.enableButton(true);
          }
        }, 2000);

      } catch (error) {
        console.error('Check-in Error:', error);
        UI.setStatus('‚ùå ' + error.message, 'error');
        UI.showSpinner(false);
        UI.enableButton(true);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }

    document.getElementById('btnCheckin').addEventListener('click', doCheckin);

    window.addEventListener('load', initLiff);
  </script>
</body>
</html>